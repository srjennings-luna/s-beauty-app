/* globals customElements document */

import {basicSetup, EditorView, json} from '../vendor/vendor.bundle.js'
import {ApiBaseElement} from './api-base.js'
import {sanityCodeMirrorTheme} from './codemirror-theme.js'
import {getSharedStyleSheets} from './shared-styles.js'

const template = document.createElement('template')
template.innerHTML = `
<style>
:host {
  grid-area: payload;
  max-height: 100%;
  height: 100%;
  overflow: hidden;
  min-height: 0;
}

@media (max-width: 40rem) {
  :host {
    max-height: none;
    min-height: 200px;
    overflow: auto;
  }
}
</style>
<div id="payloadContainer" class="gutter-gradient relative h-100 max-h-100 y-scroll border-top border-top-none-l">
  <div class="bg gutter-gradient sticky top-0 right-0 left-0 z-100">
    <div class="flex items-center space-between pad-t-2 pad-r-5 pad-b-2 pad-l-12">
      <h2 class="config-label mar-t-0 mar-b-0">Document</h2>
    </div>
    <hr class='hr-border mar-l-specific' />
  </div>
  <div id="payload" name="payload" class='max-h-100 min-h-0'></div>
</div>
<div id="deltaPayloadContainer" class="gutter-gradient relative h-100 max-h-100 y-scroll border-top border-top-none-l" style="display: none;">
  <div class="bg gutter-gradient sticky top-0 right-0 left-0 z-100">
    <div class="flex items-center space-between pad-t-2 pad-r-5 pad-b-2 pad-l-12">
      <h2 class="config-label mar-t-0 mar-b-0">Before Document</h2>
    </div>
    <hr class='hr-border' class="mar-l-specific" />
  </div>
  <div id="beforePayload" name="beforePayload" class='max-h-50 min-h-0'></div>
  <div class="bg gutter-gradient sticky top-0 right-0 left-0 z-100">
    <hr class='hr-border mar-l-specific' />
    <div class="flex items-center space-between pad-t-2 pad-r-5 pad-b-2 pad-l-12">
      <h2 class="config-label mar-t-0 mar-b-0">After Document</h2>
    </div>
    <hr class='hr-border mar-l-specific' />
  </div>
  <div id="afterPayload" name="afterPayload" class='max-h-50 min-h-0'></div>
</div>
`

class PayloadPanel extends ApiBaseElement {
  constructor() {
    super()
    this.attachShadow({mode: 'open'}).appendChild(template.content.cloneNode(true))
  }

  async connectedCallback() {
    const sheets = await getSharedStyleSheets()
    this.shadowRoot.adoptedStyleSheets = sheets

    const beforePayloadElem = this.shadowRoot.querySelector('#beforePayload')
    const afterPayloadElem = this.shadowRoot.querySelector('#afterPayload')

    this.api.store.beforePayload = attachEditorView(beforePayloadElem)
    this.api.store.afterPayload = attachEditorView(afterPayloadElem)

    const payloadElem = this.shadowRoot.querySelector('#payload')
    this.api.store.payload = attachEditorView(payloadElem)

    this.api.subscribe(this.updatePayload, ['document'])
    this.api.subscribe(this.updateSelectedEvent, ['selectedEvent'])
  }

  updatePayload = ({document}) => {
    if (!document) return

    this.#updateCodeView(this.api.store.payload, document)
    this.#updateCodeView(this.api.store.beforePayload, document)
    this.#updateCodeView(this.api.store.afterPayload, document)
  }
  #updateCodeView = (view, document) => {
    const transaction = view.state.update({
      changes: {
        from: 0,
        insert: JSON.stringify(document, null, 2),
        to: view.state.doc.length,
      },
    })
    view.dispatch(transaction)
  }
  updateSelectedEvent = ({selectedEvent}) => {
    console.log('updateSelectedEvent', selectedEvent)

    const payloadContainer = this.shadowRoot.querySelector('#payloadContainer')
    const deltaPayloadContainer = this.shadowRoot.querySelector('#deltaPayloadContainer')

    const isUpdateEvent = selectedEvent === 'update'
    payloadContainer.style.display = isUpdateEvent ? 'none' : 'block'
    deltaPayloadContainer.style.display = isUpdateEvent ? 'block' : 'none'
  }

  disconnectedCallback() {
    if (this.api) {
      this.api.unsubscribe(this.updatePayload)
    }
  }
}

function attachEditorView(parent) {
  return new EditorView({
    doc: '\n\n\n\n',
    extensions: [basicSetup, json(), sanityCodeMirrorTheme],
    parent,
  })
}

customElements.define('payload-panel', PayloadPanel)
